<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفع مجاني مباشر إلى Google Drive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            direction: rtl;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .app-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #3498db;
        }

        .form-section {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .file-upload {
            border: 2px dashed #3498db;
            border-radius: 6px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f8fafc;
            margin-bottom: 20px;
        }

        .file-upload:hover {
            background-color: #e8f4fc;
        }

        .file-upload i {
            font-size: 3.5rem;
            color: #3498db;
            margin-bottom: 15px;
        }

        .file-upload p {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .selected-files {
            background-color: #e8f4fc;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #cce7ff;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item i {
            color: #3498db;
            margin-left: 10px;
        }

        .file-name {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            color: #666;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        .btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn i {
            margin-left: 8px;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .auth-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .progress-container {
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
            display: none;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }

        .result-section {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .drive-link {
            display: inline-block;
            background-color: #4285f4;
            color: white;
            padding: 12px 25px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
        }

        .drive-link:hover {
            background-color: #3367d6;
        }

        .instructions {
            background-color: #fff9e6;
            padding: 20px;
            border-radius: 8px;
            border-right: 4px solid #f39c12;
            margin-top: 20px;
        }

        .instructions h3 {
            color: #d35400;
            margin-bottom: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            text-align: center;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }
            
            .form-section {
                padding: 20px;
            }
        }
    </style>
    <!-- مكتبة Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="app-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h1>رفع مباشر إلى Google Drive</h1>
            <p>تطبيق مجاني بالكامل - ارفع أي حجم من الملفات</p>
        </header>

        <section class="auth-section" id="authSection">
            <h3><i class="fas fa-key"></i> المصادقة مع Google Drive</h3>
            <p>لبدء الرفع، يجب السماح للتطبيق بالوصول إلى Google Drive</p>
            <button class="btn" id="authButton" onclick="handleAuthClick()">
                <i class="fab fa-google"></i> تسجيل الدخول إلى Google
            </button>
            <div class="status" id="authStatus"></div>
        </section>

        <section class="form-section" id="formSection" style="display: none;">
            <h2 class="section-title"><i class="fas fa-edit"></i> بيانات أمر العمل</h2>
            
            <form id="workOrderForm">
                <div class="form-group">
                    <label for="orderNumber"><i class="fas fa-hashtag"></i> رقم أمر العمل</label>
                    <input type="text" id="orderNumber" placeholder="مثال: WO-2023-001" required>
                </div>
                
                <div class="form-group">
                    <label for="contractorName"><i class="fas fa-user-tie"></i> اسم المقاول</label>
                    <input type="text" id="contractorName" placeholder="أدخل اسم المقاول" required>
                </div>
                
                <div class="form-group">
                    <label for="workType"><i class="fas fa-tools"></i> نوع العمل</label>
                    <input type="text" id="workType" placeholder="أدخل نوع العمل" required>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-images"></i> صور العمل</label>
                    <div class="file-upload" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>انقر لاختيار الملفات أو اسحبها هنا</p>
                        <span>يمكنك رفع أي عدد وأي حجم من الصور</span>
                    </div>
                    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
                    
                    <div class="selected-files" id="selectedFiles">
                        <h4><i class="fas fa-folder-open"></i> الملفات المختارة</h4>
                        <div id="fileList"></div>
                    </div>
                </div>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">جاري التحضير...</div>
                </div>
                
                <button type="submit" class="btn" id="submitBtn" disabled>
                    <i class="fas fa-cloud-upload-alt"></i> رفع الملفات إلى Google Drive
                </button>
            </form>
            
            <div class="result-section" id="resultSection">
                <h3><i class="fas fa-check-circle"></i> تم الرفع بنجاح!</h3>
                <p id="resultMessage"></p>
                <a id="driveLink" href="#" target="_blank" class="drive-link">
                    <i class="fab fa-google-drive"></i> افتح المجلد في Google Drive
                </a>
                <p style="margin-top: 15px; font-size: 0.9rem;">
                    يمكنك مشاركة هذا الرابط أو إغلاق الصفحة والبدء من جديد
                </p>
            </div>
            
            <div class="status" id="uploadStatus"></div>
        </section>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> طريقة استخدام التطبيق</h3>
            <ol>
                <li>انقر على زر "تسجيل الدخول إلى Google" واختر حساب Google Drive الخاص بك</li>
                <li>أدخل بيانات أمر العمل (رقم، اسم مقاول، نوع عمل)</li>
                <li>اختر الملفات التي تريد رفعها (يمكنك اختيار عدة ملفات مرة واحدة)</li>
                <li>انقر على زر "رفع الملفات إلى Google Drive"</li>
                <li>انتظر حتى يكتمل الرفع (حتى الملفات الكبيرة جداً)</li>
                <li>ستحصل على رابط مباشر للمجلد في Google Drive</li>
            </ol>
            <p><strong>مميزات هذا التطبيق:</strong></p>
            <ul>
                <li>مجاني بالكامل، لا يوجد حد شهري للرفع</li>
                <li>يدعم رفع ملفات بحجم غير محدود عملياً</li>
                <li>ينظم الملفات في مجلدات بأسماء واضحة</li>
                <li>يعمل مباشرة في المتصفح دون حاجة لاستضافة</li>
            </ul>
        </div>
    </div>

    <script>
        // بيانات اعتماد Google OAuth التي لديك
        const CLIENT_ID = '372245942674-rqk59q6b6fuqsv6n9c0hpr5r1p2brq2q.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyA4n3hF0wK...'; // ستحتاج لمفتاح API أيضاً (سيتم شرحه)
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // متغيرات التطبيق
        let tokenClient;
        let accessToken = null;
        let selectedFiles = [];
        
        // تهيئة Google API عند تحميل الصفحة
        function initGoogleAPI() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                    console.log('Google API initialized');
                } catch (error) {
                    console.error('Error initializing Google API:', error);
                }
            });
        }
        
        // معالجة تسجيل الدخول
        async function handleAuthClick() {
            const authButton = document.getElementById('authButton');
            const authStatus = document.getElementById('authStatus');
            
            authButton.disabled = true;
            authButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المصادقة...';
            
            try {
                // استخدام OAuth 2.0 implicit flow (الأبسط للمتصفح)
                const oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';
                const params = {
                    client_id: CLIENT_ID,
                    redirect_uri: window.location.origin + window.location.pathname,
                    response_type: 'token',
                    scope: SCOPES,
                    include_granted_scopes: 'true',
                    state: 'pass-through value'
                };
                
                // بناء رابط المصادقة
                const url = new URL(oauth2Endpoint);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                
                // فتح نافذة المصادقة
                const authWindow = window.open(url.toString(), 'Google Auth', 'width=500,height=600');
                
                // استمع لرسائل النافذة
                window.addEventListener('message', function(event) {
                    if (event.data && event.data.type === 'oauth_token') {
                        accessToken = event.data.token;
                        handleAuthSuccess();
                        if (authWindow) authWindow.close();
                    }
                });
                
            } catch (error) {
                showStatus('authStatus', `خطأ في المصادقة: ${error.message}`, 'error');
                authButton.disabled = false;
                authButton.innerHTML = '<i class="fab fa-google"></i> تسجيل الدخول إلى Google';
            }
        }
        
        // معالجة نجاح المصادقة
        function handleAuthSuccess() {
            const authSection = document.getElementById('authSection');
            const formSection = document.getElementById('formSection');
            const authStatus = document.getElementById('authStatus');
            
            showStatus('authStatus', 'تمت المصادقة بنجاح! يمكنك الآن رفع الملفات.', 'success');
            
            setTimeout(() => {
                authSection.style.display = 'none';
                formSection.style.display = 'block';
            }, 1500);
            
            // تفعيل اختيار الملفات
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // تفعيل إرسال النموذج
            document.getElementById('workOrderForm').addEventListener('submit', handleFormSubmit);
            
            // تفعيل تحديث زر الإرسال
            document.getElementById('orderNumber').addEventListener('input', updateSubmitButton);
            document.getElementById('contractorName').addEventListener('input', updateSubmitButton);
            document.getElementById('workType').addEventListener('input', updateSubmitButton);
        }
        
        // معالجة اختيار الملفات
        function handleFileSelect(event) {
            selectedFiles = Array.from(event.target.files);
            
            if (selectedFiles.length > 0) {
                const selectedFilesDiv = document.getElementById('selectedFiles');
                const fileListDiv = document.getElementById('fileList');
                
                fileListDiv.innerHTML = '';
                
                let totalSize = 0;
                selectedFiles.forEach((file, index) => {
                    totalSize += file.size;
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <i class="fas fa-file"></i>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    `;
                    fileListDiv.appendChild(fileItem);
                });
                
                // إضافة بند المجموع
                const totalItem = document.createElement('div');
                totalItem.className = 'file-item';
                totalItem.style.fontWeight = 'bold';
                totalItem.innerHTML = `
                    <i class="fas fa-layer-group"></i>
                    <span class="file-name">المجموع: ${selectedFiles.length} ملف</span>
                    <span class="file-size">${formatFileSize(totalSize)}</span>
                `;
                fileListDiv.appendChild(totalItem);
                
                selectedFilesDiv.style.display = 'block';
            }
            
            updateSubmitButton();
        }
        
        // تحديث زر الإرسال
        function updateSubmitButton() {
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const contractorName = document.getElementById('contractorName').value.trim();
            const workType = document.getElementById('workType').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = !(orderNumber && contractorName && workType && selectedFiles.length > 0 && accessToken);
        }
        
        // معالجة إرسال النموذج ورفع الملفات
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const orderNumber = document.getElementById('orderNumber').value.trim();
            const contractorName = document.getElementById('contractorName').value.trim();
            const workType = document.getElementById('workType').value.trim();
            
            if (!orderNumber || !contractorName || !workType || selectedFiles.length === 0) {
                showStatus('uploadStatus', 'يرجى تعبئة جميع الحقول واختيار ملفات', 'error');
                return;
            }
            
            if (!accessToken) {
                showStatus('uploadStatus', 'يرجى تسجيل الدخول أولاً', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // إعداد واجهة الرفع
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';
            progressContainer.style.display = 'block';
            
            try {
                // 1. إنشاء مجلد في Google Drive
                const folderName = `${orderNumber} ${contractorName} ${workType}`;
                updateProgress(10, 'جاري إنشاء المجلد في Drive...');
                
                const folderId = await createDriveFolder(folderName);
                
                if (!folderId) {
                    throw new Error('فشل في إنشاء المجلد');
                }
                
                // 2. رفع الملفات واحداً تلو الآخر
                let uploadedCount = 0;
                let totalSize = 0;
                
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = 10 + (i / selectedFiles.length * 80);
                    
                    updateProgress(progress, `جاري رفع الملف ${i + 1} من ${selectedFiles.length}: ${file.name}`);
                    
                    const fileId = await uploadFileToDrive(file, folderId);
                    
                    if (fileId) {
                        uploadedCount++;
                        totalSize += file.size;
                    }
                    
                    // تأخير بسيط بين الملفات لتجنب تجاوز الحدود
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // 3. عرض النتيجة
                updateProgress(100, 'تم الرفع بنجاح!');
                
                setTimeout(() => {
                    showResult(folderId, folderName, uploadedCount, totalSize);
                    progressContainer.style.display = 'none';
                    submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> رفع الملفات إلى Google Drive';
                    submitBtn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('uploadStatus', `خطأ في الرفع: ${error.message}`, 'error');
                submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> رفع الملفات إلى Google Drive';
                submitBtn.disabled = false;
                progressContainer.style.display = 'none';
            }
        }
        
        // إنشاء مجلد في Google Drive
        async function createDriveFolder(folderName) {
            try {
                const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: ['root']
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.id;
                
            } catch (error) {
                console.error('Error creating folder:', error);
                throw error;
            }
        }
        
        // رفع ملف إلى Google Drive
        async function uploadFileToDrive(file, folderId) {
            return new Promise((resolve, reject) => {
                const metadata = {
                    name: file.name,
                    mimeType: file.type,
                    parents: [folderId]
                };
                
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                formData.append('file', file);
                
                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    resolve(data.id);
                })
                .catch(error => {
                    console.error('Error uploading file:', error);
                    resolve(null); // نعود بقيمة null بدلاً من reject لمواصلة رفع الملفات الأخرى
                });
            });
        }
        
        // عرض النتيجة
        function showResult(folderId, folderName, fileCount, totalSize) {
            const resultSection = document.getElementById('resultSection');
            const resultMessage = document.getElementById('resultMessage');
            const driveLink = document.getElementById('driveLink');
            
            resultMessage.textContent = `تم رفع ${fileCount} ملف (${formatFileSize(totalSize)}) إلى مجلد "${folderName}"`;
            driveLink.href = `https://drive.google.com/drive/folders/${folderId}`;
            
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // تحديث شريط التقدم
        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = `${percent}%`;
            progressText.textContent = text;
        }
        
        // عرض رسالة حالة
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
        
        // تنسيق حجم الملف
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 بايت';
            const k = 1024;
            const sizes = ['بايت', 'كيلوبايت', 'ميجابايت', 'جيجابايت'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // عند تحميل الصفحة، تحقق إذا كان هناك token في URL (من رد OAuth)
        window.addEventListener('load', () => {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            if (params.has('access_token')) {
                accessToken = params.get('access_token');
                
                // إزالة الـ token من عنوان URL
                history.replaceState(null, null, window.location.pathname);
                
                // معالجة نجاح المصادقة
                handleAuthSuccess();
            }
            
            // تهيئة API
            initGoogleAPI();
        });
        
        // السماح بالسحب والإفلات
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.backgroundColor = '#e1f0ff';
            fileUploadArea.style.borderColor = '#2980b9';
        });
        
        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.style.backgroundColor = '#f8fafc';
            fileUploadArea.style.borderColor = '#3498db';
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.backgroundColor = '#f8fafc';
            fileUploadArea.style.borderColor = '#3498db';
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        });
    </script>
</body>
</html>